<Window x:Class="Plmeco.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:conv="clr-namespace:Plmeco.App.Converters"
        mc:Ignorable="d"
        Title="PLMECO Transporte"
        Width="1200" Height="700">

    <!-- Recursos de ventana -->
    <Window.Resources>
        <!-- Conversor robusto HH:mm para TimeSpan/strings -->
        <conv:TimeSpanTextConverter x:Key="TsText"/>
    </Window.Resources>

    <DockPanel>
        <!-- Barra superior de botones -->
        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="5">
            <Button Content="Nueva pestaña desde Excel…" Margin="2"
                    Click="NuevaPestanaDesdeExcel_Click"/>
            <Button Content="Importar en pestaña actual…" Margin="2"
                    Click="ImportarEnActual_Click"/>
            <Button Content="Guardar (pestaña)" Margin="2"
                    Click="Guardar_Click"/>
            <Button Content="Guardar como… (pestaña)" Margin="2"
                    Click="GuardarComo_Click"/>
            <Button Content="Cerrar pestaña" Margin="2"
                    Click="CerrarPestanaActual_Click"/>
        </StackPanel>

        <!-- Control de pestañas dinámicas -->
        <TabControl x:Name="TabControlDocs"
                    ItemsSource="{Binding Documents}"
                    SelectedIndex="{Binding SelectedIndex, Mode=TwoWay}"
                    Margin="5">

            <!-- Título de cada pestaña -->
            <TabControl.ItemTemplate>
                <DataTemplate>
                    <TextBlock Text="{Binding Title}" FontWeight="Bold"/>
                </DataTemplate>
            </TabControl.ItemTemplate>

            <!-- Contenido de cada pestaña -->
            <TabControl.ContentTemplate>
                <DataTemplate>
                    <DataGrid AutoGenerateColumns="False"
                              CanUserAddRows="True"
                              ItemsSource="{Binding Rows}"
                              HeadersVisibility="Column"
                              GridLinesVisibility="All"
                              AlternatingRowBackground="#F5F5F5"
                              SelectionUnit="Cell"
                              SelectionMode="Extended"
                              FontSize="13"
                              FontWeight="Normal">

                        <DataGrid.Columns>
                            <!-- ESTADO con ComboBox editable; 
                                 EstadosDisponibles debe estar en el DataContext (Window) -->
                            <DataGridTemplateColumn Header="Estado" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ComboBox SelectedItem="{Binding Estado, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                  ItemsSource="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.EstadosDisponibles}"
                                                  FontWeight="Bold"
                                                  Foreground="Black"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- PRECINTO -->
                            <DataGridTextColumn Header="Precinto"
                                                Binding="{Binding Precinto, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                Width="110"/>

                            <!-- LLEGADA REAL (usa conversor HH:mm) -->
                            <DataGridTextColumn Header="Llegada Real"
                                                Binding="{Binding LlegadaReal, Mode=TwoWay, UpdateSourceTrigger=LostFocus, Converter={StaticResource TsText}}"
                                                Width="130"/>

                            <!-- SALIDA REAL (usa conversor HH:mm) -->
                            <DataGridTextColumn Header="Salida Real"
                                                Binding="{Binding SalidaReal, Mode=TwoWay, UpdateSourceTrigger=LostFocus, Converter={StaticResource TsText}}"
                                                Width="130"/>

                            <!-- SALIDA TOPE (normalmente solo lectura; quita IsReadOnly si quieres editar) -->
                            <DataGridTextColumn Header="Salida Tope"
                                                Binding="{Binding SalidaTope, Mode=TwoWay, Converter={StaticResource TsText}}"
                                                IsReadOnly="True"
                                                Width="130"/>

                            <!-- INCIDENCIAS -->
                            <DataGridTextColumn Header="Incidencias"
                                                Binding="{Binding Incidencias, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                Width="200"/>

                            <!-- DESTINO -->
                            <DataGridTextColumn Header="Destino"
                                                Binding="{Binding Destino, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                Width="220"/>

                            <!-- LEX (si tu propiedad es booleana, usa CheckBox; 
                                 si es string, cambia a TextColumn) -->
                            <DataGridCheckBoxColumn Header="LEX"
                                                    Binding="{Binding Lex, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                    Width="70"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>
    </DockPanel>
</Window>
