<Window x:Class="Plmeco.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:Plmeco.App.Converters"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        Title="PLMECO Transporte"
        Height="600"
        Width="1000">

    <!-- Recursos -->
    <Window.Resources>
        <!-- Convertidores -->
        <conv:TimeSpanConverter x:Key="TsConv"/>
        <conv:EqualsIgnoreCaseConverter x:Key="EqI"/>
        <conv:NotEmptyConverter x:Key="NotEmpty"/>

        <!-- Opciones del desplegable ESTADO -->
        <x:Array Type="{x:Type sys:String}" x:Key="EstadoOptions">
            <sys:String>CARGANDO</sys:String>
            <sys:String>OK</sys:String>
            <sys:String>ANULADO</sys:String>
        </x:Array>

        <!-- Paleta -->
        <SolidColorBrush x:Key="RowGreen"   Color="#DFF6DD"/>
        <SolidColorBrush x:Key="RowRed"     Color="#F8D7DA"/>
        <SolidColorBrush x:Key="CellGreen"  Color="#D4EDDA"/>
        <SolidColorBrush x:Key="CellOrange" Color="#FFE5B4"/>
        <SolidColorBrush x:Key="TextDarkRed" Color="#7A0010"/>

        <!-- Texto negro y en negrita por defecto en contenido de celdas -->
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>

        <!-- Forzar texto negro también cuando la celda está seleccionada -->
        <Style TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Foreground" Value="Black"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Fila: LEX => verde; ANULADO => rojo (tiene prioridad) -->
        <Style x:Key="CargasRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="{x:Null}"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="Black"/>
            <Style.Triggers>
                <!-- Fila verde si LEX -->
                <DataTrigger Binding="{Binding Lex}" Value="True">
                    <Setter Property="Background" Value="{StaticResource RowGreen}"/>
                    <Setter Property="Foreground" Value="Black"/>
                </DataTrigger>

                <!-- Fila roja si ESTADO = ANULADO (case-insensitive) -->
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <Binding Path="Estado" Converter="{StaticResource EqI}" ConverterParameter="ANULADO"/>
                    </DataTrigger.Binding>
                    <Setter Property="Background" Value="{StaticResource RowRed}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextDarkRed}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- DESTINO verde si ESTADO = OK (case-insensitive) -->
        <Style x:Key="DestinoCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Style.Triggers>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <Binding Path="Estado" Converter="{StaticResource EqI}" ConverterParameter="OK"/>
                    </DataTrigger.Binding>
                    <Setter Property="Background" Value="{StaticResource CellGreen}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- ESTADO naranja si CARGANDO (case-insensitive) -->
        <Style x:Key="EstadoCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Style.Triggers>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <Binding Path="Estado" Converter="{StaticResource EqI}" ConverterParameter="CARGANDO"/>
                    </DataTrigger.Binding>
                    <Setter Property="Background" Value="{StaticResource CellOrange}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- INCIDENCIAS naranja si NO vacío -->
        <Style x:Key="IncidenciasCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Style.Triggers>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <Binding Path="Incidencias" Converter="{StaticResource NotEmpty}"/>
                    </DataTrigger.Binding>
                    <Setter Property="Background" Value="{StaticResource CellOrange}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- ElementStyle reutilizable -->
        <Style x:Key="BlackBoldTextBlock" TargetType="TextBlock">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
    </Window.Resources>

    <!-- Atajos -->
    <Window.InputBindings>
        <KeyBinding Key="S" Modifiers="Control" Command="{x:Static ApplicationCommands.Save}"/>
        <KeyBinding Key="S" Modifiers="Control+Shift" Command="{x:Static ApplicationCommands.SaveAs}"/>
    </Window.InputBindings>

    <Grid>
        <DockPanel>

            <!-- MENÚ -->
            <Menu DockPanel.Dock="Top">
                <MenuItem Header="_Archivo">
                    <MenuItem Header="_Guardar" Click="Guardar_Click" InputGestureText="Ctrl+S"/>
                    <MenuItem Header="Guardar _como..." Click="GuardarComo_Click" InputGestureText="Ctrl+Shift+S"/>
                    <Separator/>
                    <MenuItem Header="_Salir" Click="Salir_Click"/>
                </MenuItem>
            </Menu>

            <!-- Importar -->
            <Button DockPanel.Dock="Top" Content="Importar Excel" Click="Importar_Click" Margin="5"/>

            <!-- Tabla -->
            <DataGrid x:Name="dgCargas"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      MouseDoubleClick="DataGrid_MouseDoubleClick"
                      RowStyle="{StaticResource CargasRowStyle}"
                      Foreground="Black">

                <DataGrid.Columns>
                    <DataGridTextColumn Header="MATRICULA" Binding="{Binding Matricula}" Width="*">
                        <DataGridTextColumn.ElementStyle>
                            <StaticResource ResourceKey="BlackBoldTextBlock"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTextColumn Header="DESTINO" Binding="{Binding Destino}" Width="*"
                                        CellStyle="{StaticResource DestinoCellStyle}">
                        <DataGridTextColumn.ElementStyle>
                            <StaticResource ResourceKey="BlackBoldTextBlock"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTextColumn Header="MUELLE" Binding="{Binding Muelle}" Width="0.6*">
                        <DataGridTextColumn.ElementStyle>
                            <StaticResource ResourceKey="BlackBoldTextBlock"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- ESTADO: plantilla con TextBlock y edición con ComboBox (editable) -->
                    <DataGridTemplateColumn Header="ESTADO" CellStyle="{StaticResource EstadoCellStyle}" Width="0.8*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Estado}" FontWeight="Bold" Foreground="Black"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <ComboBox
                                    IsEditable="True"
                                    Text="{Binding Estado, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    ItemsSource="{Binding Source={StaticResource EstadoOptions}}"
                                    Foreground="Black"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <!-- Horas (editables con convertidor) -->
                    <DataGridTextColumn Header="LLEGADA REAL"
                        Binding="{Binding LlegadaReal, Converter={StaticResource TsConv}, UpdateSourceTrigger=LostFocus}"
                        Width="0.8*">
                        <DataGridTextColumn.ElementStyle>
                            <StaticResource ResourceKey="BlackBoldTextBlock"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTextColumn Header="SALIDA REAL"
                        Binding="{Binding SalidaReal, Converter={StaticResource TsConv}, UpdateSourceTrigger=LostFocus}"
                        Width="0.8*">
                        <DataGridTextColumn.ElementStyle>
                            <StaticResource ResourceKey="BlackBoldTextBlock"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTextColumn Header="SALIDA TOPE"
                        Binding="{Binding SalidaTope, Converter={StaticResource TsConv}}"
                        IsReadOnly="True" Width="0.8*">
                        <DataGridTextColumn.ElementStyle>
                            <StaticResource ResourceKey="BlackBoldTextBlock"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Incidencias -->
                    <DataGridTextColumn Header="INCIDENCIAS"
                                        Binding="{Binding Incidencias}"
                                        CellStyle="{StaticResource IncidenciasCellStyle}"
                                        Width="*">
                        <DataGridTextColumn.ElementStyle>
                            <StaticResource ResourceKey="BlackBoldTextBlock"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridCheckBoxColumn Header="LEX" Binding="{Binding Lex}" Width="0.5*"/>
                </DataGrid.Columns>
            </DataGrid>
        </DockPanel>
    </Grid>
</Window>
