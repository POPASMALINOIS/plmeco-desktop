<Window x:Class="Plmeco.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:Plmeco.App.Converters"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        Title="PLMECO Transporte"
        Height="600"
        Width="1100">

    <!-- (recursos tal como ya los tenías, sin cambios) -->
    <Window.Resources>
        <conv:TimeSpanConverter x:Key="TsConv"/>
        <conv:EqualsIgnoreCaseConverter x:Key="EqI"/>
        <conv:NotEmptyConverter x:Key="NotEmpty"/>

        <x:Array Type="{x:Type sys:String}" x:Key="EstadoOptions">
            <sys:String>CARGANDO</sys:String>
            <sys:String>OK</sys:String>
            <sys:String>ANULADO</sys:String>
        </x:Array>

        <SolidColorBrush x:Key="RowGreen"   Color="#DFF6DD"/>
        <SolidColorBrush x:Key="RowRed"     Color="#F8D7DA"/>
        <SolidColorBrush x:Key="CellGreen"  Color="#D4EDDA"/>
        <SolidColorBrush x:Key="CellOrange" Color="#FFE5B4"/>
        <SolidColorBrush x:Key="TextDarkRed" Color="#7A0010"/>

        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>

        <Style TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Foreground" Value="Black"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="CargasRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="{x:Null}"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="Black"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Lex}" Value="True">
                    <Setter Property="Background" Value="{StaticResource RowGreen}"/>
                    <Setter Property="Foreground" Value="Black"/>
                </DataTrigger>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <Binding Path="Estado" Converter="{StaticResource EqI}" ConverterParameter="ANULADO"/>
                    </DataTrigger.Binding>
                    <Setter Property="Background" Value="{StaticResource RowRed}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextDarkRed}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="DestinoCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Style.Triggers>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <Binding Path="Estado" Converter="{StaticResource EqI}" ConverterParameter="OK"/>
                    </DataTrigger.Binding>
                    <Setter Property="Background" Value="{StaticResource CellGreen}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="EstadoCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Style.Triggers>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <Binding Path="Estado" Converter="{StaticResource EqI}" ConverterParameter="CARGANDO"/>
                    </DataTrigger.Binding>
                    <Setter Property="Background" Value="{StaticResource CellOrange}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="IncidenciasCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Style.Triggers>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <Binding Path="Incidencias" Converter="{StaticResource NotEmpty}"/>
                    </DataTrigger.Binding>
                    <Setter Property="Background" Value="{StaticResource CellOrange}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="BlackBoldTextBlock" TargetType="TextBlock">
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>

        <Style x:Key="GridWithDoubleClick" TargetType="DataGrid">
            <EventSetter Event="MouseDoubleClick" Handler="DataGrid_MouseDoubleClick"/>
        </Style>
    </Window.Resources>

    <Grid>
        <DockPanel>

            <!-- MENÚ -->
            <Menu DockPanel.Dock="Top">
                <MenuItem Header="_Archivo">
                    <MenuItem Header="_Guardar (pestaña)" Click="Guardar_Click" InputGestureText="Ctrl+S"/>
                    <MenuItem Header="Guardar _como... (pestaña)" Click="GuardarComo_Click" InputGestureText="Ctrl+Shift+S"/>
                    <Separator/>
                    <MenuItem Header="Nueva pestaña desde Excel..." Click="NuevaPestanaDesdeExcel_Click"/>
                    <MenuItem Header="Importar en pestaña actual..." Click="ImportarEnActual_Click"/>
                    <MenuItem Header="Cerrar pestaña actual" Click="CerrarPestanaActual_Click"/>
                    <Separator/>
                    <MenuItem Header="_Salir" Click="Salir_Click"/>
                </MenuItem>
            </Menu>

            <!-- Barra rápida (sin Spacing; usamos Margin por estilo) -->
            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="5">
                <StackPanel.Resources>
                    <Style TargetType="Button">
                        <Setter Property="Margin" Value="0,0,6,0"/>
                    </Style>
                </StackPanel.Resources>
                <Button Content="Nueva pestaña desde Excel..." Click="NuevaPestanaDesdeExcel_Click"/>
                <Button Content="Importar en pestaña actual..." Click="ImportarEnActual_Click"/>
                <Button Content="Guardar (pestaña)" Click="Guardar_Click"/>
                <Button Content="Guardar como... (pestaña)" Click="GuardarComo_Click"/>
                <Button Content="Cerrar pestaña" Click="CerrarPestanaActual_Click"/>
            </StackPanel>

            <!-- TABS (igual que tenías) -->
            <TabControl x:Name="tabControl"
                        ItemsSource="{Binding Documents}"
                        SelectedIndex="{Binding SelectedIndex, Mode=TwoWay}">
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Title}" FontWeight="Bold"/>
                    </DataTemplate>
                </TabControl.ItemTemplate>

                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <DataGrid Style="{StaticResource GridWithDoubleClick}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  ItemsSource="{Binding Rows}"
                                  RowStyle="{StaticResource CargasRowStyle}"
                                  Foreground="Black"
                                  Margin="5">

                            <DataGrid.Columns>
                                <DataGridTextColumn Header="MATRICULA" Binding="{Binding Matricula}" Width="*">
                                    <DataGridTextColumn.ElementStyle>
                                        <StaticResource ResourceKey="BlackBoldTextBlock"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="DESTINO" Binding="{Binding Destino}" Width="*"
                                                    CellStyle="{StaticResource DestinoCellStyle}">
                                    <DataGridTextColumn.ElementStyle>
                                        <StaticResource ResourceKey="BlackBoldTextBlock"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="MUELLE" Binding="{Binding Muelle}" Width="0.6*">
                                    <DataGridTextColumn.ElementStyle>
                                        <StaticResource ResourceKey="BlackBoldTextBlock"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- ESTADO con ComboBox editable -->
                                <DataGridTemplateColumn Header="ESTADO" CellStyle="{StaticResource EstadoCellStyle}" Width="0.8*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Estado}" FontWeight="Bold" Foreground="Black"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ComboBox IsEditable="True"
                                                      Text="{Binding Estado, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      ItemsSource="{Binding Source={StaticResource EstadoOptions}}"
                                                      Foreground="Black"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <!-- PRECINTO -->
                                <DataGridTextColumn Header="PRECINTO" Binding="{Binding Precinto}" Width="0.8*">
                                    <DataGridTextColumn.ElementStyle>
                                        <StaticResource ResourceKey="BlackBoldTextBlock"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Horas -->
                                <DataGridTextColumn Header="LLEGADA REAL"
                                    Binding="{Binding LlegadaReal, Converter={StaticResource TsConv}, UpdateSourceTrigger=LostFocus}"
                                    Width="0.8*">
                                    <DataGridTextColumn.ElementStyle>
                                        <StaticResource ResourceKey="BlackBoldTextBlock"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="SALIDA REAL"
                                    Binding="{Binding SalidaReal, Converter={StaticResource TsConv}, UpdateSourceTrigger=LostFocus}"
                                    Width="0.8*">
                                    <DataGridTextColumn.ElementStyle>
                                        <StaticResource ResourceKey="BlackBoldTextBlock"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="SALIDA TOPE"
                                    Binding="{Binding SalidaTope, Converter={StaticResource TsConv}}"
                                    IsReadOnly="True" Width="0.8*">
                                    <DataGridTextColumn.ElementStyle>
                                        <StaticResource ResourceKey="BlackBoldTextBlock"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="INCIDENCIAS"
                                                    Binding="{Binding Incidencias}"
                                                    CellStyle="{StaticResource IncidenciasCellStyle}"
                                                    Width="*">
                                    <DataGridTextColumn.ElementStyle>
                                        <StaticResource ResourceKey="BlackBoldTextBlock"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridCheckBoxColumn Header="LEX" Binding="{Binding Lex}" Width="0.5*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
        </DockPanel>
    </Grid>
</Window>
